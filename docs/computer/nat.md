# NAT

network address translation，网络地址转换。

现在 ip 地址短缺，通常情况下，一个局域网，只有一个公网IP，任何在公网上的数据包，想发送给某一个局域网中某一台电脑，都只能发送到这个局域网的 NAT 主机上，通过主机修改数据包中的目的 IP到这个网络中具体的主机，来实现通信。

NAT 类型

由于 IPV4 短缺，并且为了保护子网中的设备，一个网络就有 NAT 网关，

network address translation 网络地址转换

nat 网关处理内网内的设备请求外网上的数据包，把内网设备的 IP+port 修改成这个网络的公网IP+port。

当外网上的数据发到这个网络内的设备时，nat 网关便再次转换

在 nat 设备中维护了这个替换地址的映射表，外部网络发来的数据包能否进入内网，主要看是否有可转换的映射表项，没有就直接丢弃了。

nat 设备的外网地址可以是一个 IP，也可以是一个 IP 段，形成 IP 池。nat 设备也可以直接把一个公网 IP 映射到内网上的一个机器，这样公网就可以直接访问内网上的机器了，
这个过程叫什么？内网穿透？

地址映射表的建立需要内网主动访问外网，或者由 nat 设备静态设置。

根据建立地址映射表的类型不同，nat 有几种分类

完全锥型NAT
即内网的机器 ip+port 在映射表中对应着一个 ip + port，外网的任何机器都能直接给这个机器发送数据包

限制型锥型 nat
内网的机器 IP + port 在映射表中只有一个 IP + port，但只有内网机器主动发起请求的服务端机器，才能主动给这个内网机器发数据包

端口限制型 NAT
内网的机器在映射表只有一个 IP + port，且只有内网机器主动发起请求的服务端机器的 ip + port 对应的程序，才能主动给这个内网机器发数据包

对称型 NAT 就是内网的一个 IP + port 对应着外网的一个机器的 IP + port，只有那个 IP + port 才能主动给内网的 IP + port 发送数据。

这种最严格，所以一般只有3g，4g，公共WiFi 才会这样设置，为了保证安全。


nat 优点有很多，解决 ipv4 地址短缺，构建防火墙保护网络安全等。

却破坏了端到端的网络通信，为了让跨越 nat 网关的主机之间可以相互通信，需要用到 nat 穿透，也叫做 nat 打洞。


STUN session traversal utilities for nat，nat 会话穿越应用程序，允许通过 nat 网关后，找到对应的子网内设备的公网 IP，查出该主机属于什么 nat 类型。


首先 stun 客户端用同一个端口给两个 server 发送请求，两个 server 拿到客户端的 ip + 端口后，去判断 ip 地址是否一致，若不一致，那就说明是对称型 nat，否则就是锥型。

server2 把自己收到的 IP + port + message 发送给 server1，server1 发给客户端，如果客户端能收到，说明是完全锥型，否则就是限制型锥型


server1 在 port 8000 下收到客户端的 IP+port+message，再开一个服务，端口不一致，然后发给客户端，客户端如果能接收到，说明是 ip 限制型锥型，否则就是端口限制型锥型